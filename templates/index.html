<!DOCTYPE html>
<html>
<head>
    <title>Fishermen Safety Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <style>
        /* Full-page sea background */
        body { 
            font-family: Arial; 
            margin:0; 
            padding:0; 
            background-image: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=1950&q=80');
            background-size: cover;
            background-position: center;
            color: white;
        }
        h2 {
            text-align:center;
            padding:15px;
            background: rgba(0,0,0,0.5);
            margin:0;
        }
        #map { 
            height: 500px; 
            width: 100%; 
            margin-bottom: 10px;
        }
        .card {
            padding: 15px;
            border-radius: 10px;
            margin: 10px;
            background: rgba(0,0,0,0.6);
        }
        #networkStatus { font-weight:bold; text-align:center; }
        #safetyStatus { font-weight:bold; font-size:18px; text-align:center; }
        #harborInfo, #weatherInfo, #fishInfo, #debugLocation { font-size:16px; }
        #sosBtn {
            background:red; 
            color:white; 
            padding:10px; 
            border:none;
            border-radius:5px; 
            cursor:pointer; 
            display:block; 
            width: 100%;
            margin: 10px auto;
            font-size:16px;
        }
    </style>
</head>
<body>

<h2>Fishermen Safety Dashboard</h2>

<div class="card" id="networkStatus">Checking network...</div>
<button id="sosBtn">ðŸš¨ SOS</button>
<div class="card" id="safetyStatus">Checking sea conditions...</div>
<div class="card" id="harborInfo">Nearest Harbor: Loading...</div>
<div class="card" id="weatherInfo">Loading weather...</div>
<div class="card" id="fishInfo">Nearby Fish Spots: Loading...</div>
<div class="card" id="debugLocation">DEBUG: Waiting for location...</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// ------------------------
// Online / Offline Status
// ------------------------
function updateNetworkStatus() {
    const statusDiv = document.getElementById('networkStatus');
    if (navigator.onLine) {
        statusDiv.innerText = "ðŸ“¡ Online Mode";
        statusDiv.style.backgroundColor = "green";
    } else {
        statusDiv.innerText = "ðŸ“¡ Offline Mode â€“ Using cached data";
        statusDiv.style.backgroundColor = "orange";
    }
}
updateNetworkStatus();
window.addEventListener('online', updateNetworkStatus);
window.addEventListener('offline', updateNetworkStatus);

// ------------------------
// SOS Button
// ------------------------
document.getElementById('sosBtn').addEventListener('click', function () {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (pos) {
            const lat = pos.coords.latitude.toFixed(6);
            const lon = pos.coords.longitude.toFixed(6);
            const seaStatus = document.getElementById('safetyStatus').innerText.split('\n')[0];
            const contacts = ["Family Member / Close Contact","Indian Coast Guard","Kerala Fisheries Dept"];
            contacts.forEach(c => alert(`ðŸš¨ SOS sent to ${c}\nLatitude: ${lat}\nLongitude: ${lon}\nStatus: ${seaStatus}`));
        }, function() { alert("GPS not available! SOS cannot be sent."); });
    } else {
        alert("GPS not supported! SOS cannot be sent.");
    }
});

// ------------------------
// Distance calculation
// ------------------------
function getDistance(lat1, lon1, lat2, lon2) {
    var R = 6371;
    var dLat = (lat2-lat1)*Math.PI/180;
    var dLon = (lon2-lon1)*Math.PI/180;
    var a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    var c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R*c;
}

// ------------------------
// Update Cards
// ------------------------
function updateSafetyCard(weatherData, harborData=null, nearbyFish=[]) {
    const safetyBox = document.getElementById('safetyStatus');
    const color = weatherData.safety.includes("Dangerous") ? "red"
                : weatherData.safety.includes("Rough") ? "orange"
                : weatherData.safety.includes("Breezy") ? "gold"
                : "green";
    safetyBox.innerHTML = `SEA STATUS: ${weatherData.safety}<br>ðŸŒ¡ Temp: ${weatherData.temp}Â°C | ðŸŒ¬ Wind: ${weatherData.wind_knots} knots`;
    safetyBox.style.backgroundColor = color;

    if(harborData) document.getElementById('harborInfo').innerText =
        `ðŸ›³ Nearest Harbor: ${harborData.name} | Distance: ${harborData.distance_km} km | Direction: ${harborData.direction}`;

    document.getElementById('weatherInfo').innerText =
        `ðŸŒ¡ Temp: ${weatherData.temp}Â°C | ðŸŒ¬ Wind: ${weatherData.wind_kph} kph (${weatherData.wind_knots} knots)` +
        (weatherData.storm_alert ? " | âš ï¸ Cyclone / Storm Alert!" : "");

    const fishDiv = document.getElementById('fishInfo');
    if (nearbyFish.length>0) {
        fishDiv.innerHTML = "Nearby Fish Spots:<br>" + nearbyFish.map(f => `ðŸš¢ ${f.name} (${f.dist.toFixed(2)} km)`).join('<br>');
    } else {
        fishDiv.innerHTML = "Nearby Fish Spots: None within 2 km";
    }
}

// ------------------------
// Initialize Map
// ------------------------
const defaultLat = 9.9312;  // Kochi
const defaultLon = 76.2673;
const map = L.map('map').setView([defaultLat, defaultLon], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);

// Harbors & Fish spots (passed from Flask)
const harbors = {{ harbors | tojson | safe }};
harbors.forEach(h => L.marker([h[1], h[2]], {icon: L.icon({iconUrl:'https://maps.google.com/mapfiles/ms/icons/blue-dot.png', iconSize:[32,32]})}).addTo(map).bindPopup(h[0]));

const shipIcon = L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png',iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-32]});
const fish_spots = {{ fish_spots | tojson | safe }};
fish_spots.forEach(f => L.marker([f[1], f[2]], {icon: shipIcon}).addTo(map).bindPopup(`<b>${f[0]}</b><br>Good fishing spot!`));

// ------------------------
// Load Dashboard
// ------------------------
function loadDashboard(lat, lon) {
    document.getElementById('debugLocation').innerText = `DEBUG: Using GPS â†’ Latitude: ${lat}, Longitude: ${lon}`;
    L.marker([lat, lon], {icon:L.icon({iconUrl:'https://maps.google.com/mapfiles/ms/icons/red-dot.png',iconSize:[32,32]})}).addTo(map).bindPopup("You are here").openPopup();
    map.setView([lat, lon], 11);

    const nearbyFish = fish_spots.map(f => ({name:f[0],dist:getDistance(lat,lon,f[1],f[2])})).filter(f => f.dist<=2);

    function fetchData() {
        fetch(`/weather/${lat}/${lon}`).then(r=>r.json()).then(weatherData=>{
            localStorage.setItem('lastWeather', JSON.stringify(weatherData));
            fetch(`/nearest_harbor/${lat}/${lon}`).then(r=>r.json()).then(harborData=>{
                localStorage.setItem('lastHarbor', JSON.stringify(harborData));
                updateSafetyCard(weatherData, harborData, nearbyFish);
            }).catch(console.error);
        }).catch(console.error);
    }

    if (navigator.onLine) fetchData();
    else {
        const cachedWeather = JSON.parse(localStorage.getItem('lastWeather'));
        const cachedHarbor = JSON.parse(localStorage.getItem('lastHarbor'));
        if(cachedWeather) updateSafetyCard(cachedWeather, cachedHarbor, nearbyFish);
    }
}

// ------------------------
// Main: GPS or fallback
// ------------------------
if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
        pos => loadDashboard(pos.coords.latitude, pos.coords.longitude),
        () => { loadDashboard(defaultLat, defaultLon); alert("GPS access denied, using fallback location (Kochi)."); }
    );
} else {
    loadDashboard(defaultLat, defaultLon);
    alert("GPS not supported, using fallback location (Kochi).");
}

</script>
</body>
</html>